<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pac-Man</title>
  <link rel="icon"
      type="image/png"
      href="./images/sprite-pacman.png">
  <link rel="stylesheet" type="text/css" href="./stylesheet.css">
</head>
<body>
  <div id="pacman">
  </div>

  <div id="scoreboard">
  </div>


  <audio id='chomp'>
    <source src="./sound/pacman_chomp.wav" type="audio/wav">
  </audio>

</body>

<script>

  // 0 === wall
  // 1 === dot
  // 2 === empty
  // 3 === ghost
  // 4 === power pellet
  // 5 === pacman
  let rightPressed = false;
  let leftPressed = false;
  let upPressed = false;
  let downPressed = false;

  document.addEventListener("keydown", keyDownHandler, false);

  function keyDownHandler(e) {
    switch (e.keyCode) {
      case 37:
        leftPressed = true;
        rightPressed = false;
        upPressed = false;
        downPressed = false;
        break;
      case 38:
        upPressed = true;
        leftPressed = false;
        rightPressed = false;
        downPressed = false;
        break;
      case 39:
        rightPressed = true;
        upPressed = false;
        leftPressed = false;
        downPressed = false;
        break;
      case 40:
        downPressed = true;
        upPressed = false;
        leftPressed = false;
        rightPressed = false;
        break;
      default:
        break;
    }
  }

  let score = 0;

  const pacman = {
    col: 9,
    row: 12,
    lives: 3,
  }

  class Ghost {
    constructor(name, abbr, col, row, moves) {
      this.name = name;
      this.abbr = abbr;
      this.col = col;
      this.row = row;
      this.moves = moves;
      this.dir = null;
      this.prevSpace = null;
      this.vulnerable = false;
    }
  }

  const pinky = new Ghost('pinky', 'gp', 9, 9);
  const blinky = new Ghost('blinky', 'gb', 8, 10);
  const inky = new Ghost('inky','gi', 9, 10);
  const clyde = new Ghost('clyde', 'gc', 10, 10);
  const ghosts = [pinky, blinky, inky, clyde];

  const maze = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 4, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 4, 0],
    [0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0],
    [0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0],
    [0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0],
    [2, 2, 2, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 2, 2, 2],
    [0, 0, 0, 0, 1, 0, 1, 0, 0, 'gp', 0, 0, 1, 0, 1, 0, 0, 0, 0],
    [2, 2, 2, 2, 1, 1, 1, 0, 'gb', 'gi', 'gc', 0, 1, 1, 1, 2, 2, 2, 2],
    [0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0],
    [2, 2, 2, 0, 1, 0, 1, 1, 1, 5, 1, 1, 1, 0, 1, 0, 2, 2, 2],
    [0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0],
    [0, 4, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 4, 0],
    [0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0],
    [0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0],
    [0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0],
    [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
  ];

  function drawScore() {
    let innerHTMLStr = `<div class='score'> Score: ${score} </div>`
    innerHTMLStr +=   `<div class='lives'>Lives: `

    const pacmanLifeStr = `<img src='https://res.cloudinary.com/deor0br3s/image/upload/v1523921737/sprite-pacman.png' /> `

    for (let i = 0; i < pacman.lives; i++) {
      innerHTMLStr += pacmanLifeStr;
    }
    innerHTMLStr += `</div>`;

    document.getElementById('scoreboard').innerHTML = innerHTMLStr;
  }

  function checkGameOver() {
    if (pacman.lives === 0) {
       return true;
    }
    return false;
  }

  function drawMaze() {
    movePacman();
    ghosts.forEach(ghost => {
      moveGhost(ghost);
    })

    // checkGameOver();
    drawScore();

    let innerHTMLStr = "";
    for (let row = 0; row < maze.length; row += 1) {
      for (let col = 0; col < maze[0].length; col += 1) {
        switch (maze[row][col]) {
          case 0:
            innerHTMLStr += "<div class='wall'></div>"
            break;
          case 1:
            innerHTMLStr += "<div class='dot'></div>"
            break;
          case 2:
            innerHTMLStr += "<div class='ground'></div>"
            break;
          case 'gp':
            innerHTMLStr += "<div class='pinky'></div>"
            break;
          case 'gi':
            innerHTMLStr += "<div class='inky'></div>"
            break;
          case 'gb':
            innerHTMLStr += "<div class='blinky'></div>"
            break;
          case 'gc':
            innerHTMLStr += "<div class='clyde'></div>"
            break;
          case 'blue':
            innerHTMLStr += "<div class='blue-ghost'></div>"
            break;
          case 4:
            innerHTMLStr += "<div class='power-pellet'></div>"
            break;
          case 5:
            if (leftPressed) {
              innerHTMLStr += "<div class='pacman-left'></div>"
            } else if (downPressed) {
              innerHTMLStr += "<div class='pacman-down'></div>"
            } else if (upPressed) {
              innerHTMLStr += "<div class='pacman-up'></div>"
            } else {
              innerHTMLStr += "<div class='pacman-right'></div>"
            }
            break;
        }
      }
    }

    document.getElementById('pacman').innerHTML = innerHTMLStr;
  }

  function getRandomDirection() {
    const directions = ['LEFT', 'UP', 'DOWN', 'RIGHT'];
    return directions[Math.floor(Math.random() * 4)]
  }

  function moveGhost(ghost) {
    const abbr = ghost.vulnerable ? 'blue': ghost.abbr;
    maze[ghost.row][ghost.col] = abbr;
    let ghostNextRow;
    let ghostNextCol;

    if (ghost.dir) {
      switch(ghost.dir) {
        case 'LEFT':
          ghostNextRow = ghost.row;
          ghostNextCol = ghost.col - 1;
          break;
        case 'UP':
          ghostNextRow = ghost.row - 1;
          ghostNextCol = ghost.col;
          break;
        case 'RIGHT':
          ghostNextRow = ghost.row;
          ghostNextCol = ghost.col + 1;
          break;
        case 'DOWN':
          ghostNextRow = ghost.row + 1;
          ghostNextCol = ghost.col;
          break;
      }

      let nextLoc = maze[ghostNextRow][ghostNextCol];

      if (nextLoc == 5 && !ghost.vulnerable)  {
        maze[ghost.row][ghost.col] = ghost.prevSpace || 2;
        [ghost.row, ghost.col] = [ghostNextRow, ghostNextCol]
        ghost.prevSpace = 2;
        maze[12][9] = 5;
        [pacman.row, pacman.col] = [12, 9];
        pacman.lives = pacman.lives - 1;
        maze[ghost.row][ghost.col] = abbr;

        const audio= new Audio('./sound/pacman_death.wav');
        audio.play();
      } else if (nextLoc > 0 && nextLoc < 5) {
        maze[ghost.row][ghost.col] = ghost.prevSpace || 2;
        ghost.prevSpace = nextLoc;
        [ghost.row, ghost.col] = [ghostNextRow, ghostNextCol]
        maze[ghost.row][ghost.col] = abbr;
      } else {
        ghost.dir = getRandomDirection();
      }
    } else {
      ghost.dir = getRandomDirection();
    }
  }

  function movePacman() {

    let pacmanNextRow;
    let pacmanNextCol;

    if (leftPressed) {
      pacmanNextRow = pacman.row;
      pacmanNextCol = pacman.col - 1;
    } else if (upPressed) {
      pacmanNextRow = pacman.row - 1;
      pacmanNextCol = pacman.col;
    } else if (rightPressed) {
      pacmanNextRow = pacman.row;
      pacmanNextCol = pacman.col + 1;
    } else if (downPressed) {
      pacmanNextRow = pacman.row + 1;
      pacmanNextCol = pacman.col;
    } else {
      return;
    }

    const nextLoc = maze[pacmanNextRow][pacmanNextCol];

    if (nextLoc != 0) {
      if (nextLoc == 1) {
        score += 10;
        const chomp = document.getElementById('chomp');
        chomp.pause();
        chomp.play();
      } else if (nextLoc == 4) {
        const audio = new Audio('./sound/pacman_eatfruit.wav');
        audio.play();

        ghosts.forEach(ghost => {
          ghost.vulnerable = true;
        })

        setTimeout(() => ghosts.forEach( ghost => {
          ghost.vulnerable = false;
        }), 9000);
      }  else if (nextLoc === 'blue') {
        score += 200;
        let ghost = ghosts.filter(ghost => ghost.row == pacmanNextRow && ghost.col == pacmanNextCol)[0];
        maze[ghost.row][ghost.col] = 2;
        [ghost.row, ghost.col] = [9, 9];
        ghost.vulnerable = false;
        maze[9][9] = ghost.abbr;
        const audio = new Audio('./sound/pacman_eatghost.wav');
        audio.play();
      }

      maze[pacman.row][pacman.col] = 2;
      [pacman.row, pacman.col] = [pacmanNextRow, pacmanNextCol];
      maze[pacmanNextRow][pacmanNextCol] = 5;
    }
  }

  drawMaze();
  const audioStart = new Audio('./sound/pacman_beginning.wav');
  audioStart.play();

  window.setInterval(drawMaze, 200)
</script>
</html>
